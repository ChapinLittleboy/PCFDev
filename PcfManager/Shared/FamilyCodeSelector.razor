@using Syncfusion.Blazor.Lists
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using PcfManager.Models

<div class="family-code-selector">
    @if (ShowSelectAll)
    {
        <SfCheckBox TValue="bool" @bind-Checked="AllSelected" Label="Select All Families"></SfCheckBox>
    }

    <SfListBox TItem="FamilyCode"
               DataSource="AvailableCodes"
               TValue="string[]"
               @bind-Value="SelectedCodesLocal"
               Height="300px">
        <ListBoxSelectionSettings ShowCheckbox="true"></ListBoxSelectionSettings>
        <ListBoxFieldSettings Text="family_display" Value="family_code"></ListBoxFieldSettings>
    </SfListBox>

    @if (SelectedCodesLocal?.Any() ?? false)
    {
        <table class="table table-sm mt-2">
            <thead>
                <tr>
                    <th>Family Code</th>
                    <th>% Increase</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var codea in SelectedCodesLocal)
                {
                    <tr>
                        <td>@codea</td>
                        <td>
                            <SfNumericTextBox @bind-Value="CodeIncreases[codea]"
                                              Placeholder="0"
                                              Min="-50" Max="50"
                                              Format="##.##"
                                              FloatLabelType="FloatLabelType.Never"
                                              Width="100px"
                                              ShowSpinButton="false" />%
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter] public List<FamilyCode> AvailableCodes { get; set; } = new();
    [Parameter] public string[] SelectedCodes { get; set; } = Array.Empty<string>();
    [Parameter] public EventCallback<string[]> SelectedCodesChanged { get; set; }

    [Parameter] public Dictionary<string, double> CodeIncreases { get; set; } = new();
    [Parameter] public EventCallback<Dictionary<string, double>> CodeIncreasesChanged { get; set; }

    [Parameter] public bool ShowSelectAll { get; set; } = false;

    private string[] SelectedCodesLocal
    {
        get => SelectedCodes;
        set
        {

            var codes = value ?? Array.Empty<string>();

            SelectedCodes = codes;
            // Initialize or clean up percentages
            foreach (var code in codes)
            {
                if (!CodeIncreases.ContainsKey(code))
                    CodeIncreases[code] = 0;
            }
            var removed = CodeIncreases.Keys.Except(codes).ToList();
            foreach (var code in removed)
                CodeIncreases.Remove(code);

            SelectedCodesChanged.InvokeAsync(SelectedCodes);
            CodeIncreasesChanged.InvokeAsync(CodeIncreases);
        }
    }

    private bool AllSelected
    {
        get => AvailableCodes.Select(f => f.family_code).All(c => SelectedCodes.Contains(c));
        set
        {
            if (value)
                SelectedCodesLocal = AvailableCodes.Select(f => f.family_code).ToArray();
            else
                SelectedCodesLocal = Array.Empty<string>();
        }
    }
}
