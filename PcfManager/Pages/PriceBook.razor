@page "/pricebook"
@using Chapin.PriceBook
@using Microsoft.AspNetCore.Mvc.Routing

@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IPriceBookGenerator Generator
@inject IUserService UserSvc
@inject ITemplateProvider TemplateProvider
@inject IWebHostEnvironment _env




@attribute [Authorize]

<h3 class="mb-3">Generate MSD Price Book</h3>

<EditForm Model="_vm" OnValidSubmit="GenerateAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    
    <div class="mb-3">
        <label class="form-label">Template</label>

        <InputSelect class="form-control" @bind-Value="_vm.TemplatePath">
            @if ((_templates?.Count ?? 0) == 0)
            {
                <option disabled selected value="">(no templates found)</option>
            }
            else
            {
                @foreach (var t in _templates)
                {
                    <option value="@t.Path">@t.Name</option>
                }
            }
        </InputSelect>

        <div class="form-text">
            Excel templates on the server (private folder, not web-accessible).
        </div>
    </div>
    <!--
    <div class="mb-3">
        <label class="form-label">Template path</label>
        <InputText class="form-control" @bind-Value="_vm.TemplatePath" />
        <div class="form-text">Path on the server where the Blazor app is running.</div>
    </div>
    -->
    <div class="mb-3">
        <label class="form-label">Source</label>
        <InputSelect class="form-select" @bind-Value="_vm.SourceKey">
            <option value="sql">Syteline (ItemPrice table)</option>
            <option value="pit">Price Increase tool</option>
        </InputSelect>
    </div>
    
    

    @if (_vm.SourceKey == "sql")
    {
        <div class="form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="_vm.ExcludeFuturePrices"/>
            <label class="form-check-label">Exclude future-dated prices</label>
        </div>
    }

    <button class="btn btn-primary text-white" type="submit" disabled="@_busy">
        @_buttonText
    </button>
    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <div class="text-danger mt-3">@_error</div>
    }
  
</EditForm>

@code {
    private IReadOnlyList<TemplateItem> _templates = Array.Empty<TemplateItem>();


    protected override async Task OnInitializedAsync()
    {
        _templates = await TemplateProvider.GetTemplatesAsync(
            useWebRoot: false,              // <-- private: ContentRoot/Templates/PriceBooks
            subfolder: "Templates/PriceBooks",
            searchPattern: "*.xlsx"
        );

        // keep selection valid if app state had an old value
        if (!string.IsNullOrWhiteSpace(_vm.TemplatePath) &&
            !_templates.Any(x => string.Equals(x.Path, _vm.TemplatePath, StringComparison.OrdinalIgnoreCase)))
        {
            _vm.TemplatePath = "";
        }
    }





    private GenerateVm _vm = new()
    {
        //TemplatePath = @"C:\data\HDA MSD Price Book Template v2.xlsx",
        TemplatePath = @"C:\users\willit2\Downloads\HDA MSD Price Book Template v2.xlsx",
        SourceKey = "sql",
        ExcludeFuturePrices = true
    };

    private bool _busy = false;
    private string _buttonText => _busy ? "Generating..." : "Generate & Download";
    private string? _error;

    private sealed class GenerateVm
    {
        public string TemplatePath { get; set; } = "";
        public string SourceKey { get; set; } = "sql";
        public bool ExcludeFuturePrices { get; set; } = true;
    }

    private async Task GenerateAsync()
    {
        _error = null;
        _busy = true;
        try
        {
            var req = new PriceBookRequest(
                TemplatePath: _vm.TemplatePath,
                SourceKey: "sql",
                ExcludeFuturePrices: true,
                OutputFileName: $"MSD Price Book - {DateTime.Now:yyyyMMdd-HHmm}.xlsx");

            var bytes = await Generator.GenerateAsync(req);

            // --- Save a copy on the server ---
            var userId = UserSvc.DomainUserName ?? "Anonymous"; // Or however you identify the user
            var timestamp = DateTime.Now.ToString("yyyyMMdd-HHmmss");
            var safeUser = string.Concat(userId.Split(Path.GetInvalidFileNameChars())); // sanitize for file system

            var serverFileName = $"PriceBook_{safeUser}_{timestamp}.xlsx";

            // Use IWebHostEnvironment.ContentRootPath (inject it into your component/service)
            var saveDir = Path.Combine(_env.ContentRootPath, "GeneratedPriceBooks");
            Directory.CreateDirectory(saveDir);

            var savePath = Path.Combine(saveDir, serverFileName);
            await File.WriteAllBytesAsync(savePath, bytes);

            // --- Stream file back to browser as before ---
            var downloadName = "MSD Price Book (Generated).xlsx";
            using var streamRef = new DotNetStreamReference(new MemoryStream(bytes));
            await JS.InvokeVoidAsync("downloadFileFromStream", downloadName, streamRef);
        }
        catch (Exception ex)
        {
            _error = $"Error generating price book: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }
    private async Task OldGenerateAsync()
    {
        _error = null;
        _busy = true;
        try
        {


            var req = new PriceBookRequest(
                TemplatePath: _vm.TemplatePath,
                SourceKey: "sql",
                ExcludeFuturePrices: true,
                OutputFileName: $"MSD Price Book - {DateTime.Now:yyyyMMdd-HHmm}.xlsx");



            var bytes = await Generator.GenerateAsync(req);
            
     
            
            var fileName = "MSD Price Book (Generated).xlsx";
            
            using var streamRef = new DotNetStreamReference(new MemoryStream(bytes));
            await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
        }
        catch (Exception ex)
        {
            _error = $"Error generating price book: {ex.Message}";
        }
        finally
        {
            _busy = false;
        }
    }
}
