@page "/pcf-detail-report"
@using PcfManager.Models  @* Adjust to your actual namespace *@
@using Syncfusion.Blazor.Grids
@inject DataService DataService

<PageTitle>PCF Program Details</PageTitle>

<h3>PCF Program Details</h3>
<div>
    <div class="active-filters">
        <button @onclick="ClearFilters">Clear Filters</button>

        <!--
        <span class="divider">|</span>
        <strong class="small-text">Active Filters:</strong>
        <span class="small-text">@activeFilters</span>
        -->
    </div>

</div>
<SfGrid ID="PcfsDetGrid" @ref="MyDetGrid" DataSource="@pcfDetails" AllowSorting="true" AllowPaging="true" AllowFiltering="true"
        AllowExcelExport="true" Toolbar="@(new string[] { "ExcelExport", "ColumnChooser" })" 
        AllowReordering="true" AllowResizing="true" 
        AllowTextWrap="true"
        EnablePersistence="true"
        ShowColumnChooser="true"
        AllowGrouping="true" Height="auto" Width="90%">
    <GridTextWrapSettings WrapMode="WrapMode.Header"/>
    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
    <GridEvents OnToolbarClick="ToolbarClickHandler"  TValue="PCFDetail"></GridEvents>
    <GridPageSettings PageSize="20"  PageSizes="@(new string[] { "20", "50", "100", "All" })"></GridPageSettings>
    <GridColumns>
        <GridColumn Field="PCFNum" HeaderText="PCF #" TextAlign="TextAlign.Center" Width="100" Type="ColumnType.Number"/>
        <GridColumn Field="CustomerNumber" HeaderText="Customer #" Width="120"/>
        <GridColumn Field="CustomerName" HeaderText="Customer Name" Width="200"/>
        <GridColumn Field="StartDate" HeaderText="Start Date" Format="d" Type="ColumnType.Date" Width="120"/>
        <GridColumn Field="EndDate" HeaderText="End Date" Format="d" Type="ColumnType.Date" Width="120"/>
        <GridColumn Field="PCFStatus" HeaderText="Status" TextAlign="TextAlign.Center" Width="100"/>
        <GridColumn Field="PcfType" HeaderText="Type" Width="100"/>
        <GridColumn Field="ItemNum" HeaderText="Item #" Width="120"/>
        <GridColumn Field="ItemDesc" HeaderText="Item Description" Width="200"/>
        <GridColumn Field="ItemStatus" HeaderText="Item Status" Width="120"/>
        <GridColumn Field="PrivateLabelFlag" HeaderText="Private Label" Width="120"/>
        <GridColumn Field="CustNum" HeaderText="Cust #" Width="100"/>
        <GridColumn Field="VPSalesDate" HeaderText="VP Sales Date" Format="d" Type="ColumnType.Date" Width="130"/>
        <GridColumn Field="BuyingGroup" HeaderText="Buying Group" Width="150"/>
        <GridColumn Field="GeneralNotes" HeaderText="Notes" Width="200"/>
        <GridColumn Field="PromoPaymentTermsText" HeaderText="Payment Terms" Width="160"/>
        <GridColumn Field="PromoFreightTerms" HeaderText="Freight Terms" Width="160"/>
        <GridColumn Field="FreightMinimums" HeaderText="Freight Min." Width="130"/>
        <GridColumn Field="SalesManager" HeaderText="Sales Manager" Width="150"/>
        <GridColumn Field="BillToAddress" HeaderText="Bill To Address" Width="200"/>
        <GridColumn Field="BillToCity" HeaderText="City" Width="120"/>
        <GridColumn Field="BTState" HeaderText="State" Width="80"/>
        <GridColumn Field="BTZip" HeaderText="ZIP" Width="100"/>
        <GridColumn Field="EUT" HeaderText="EUT" Width="100"/>
        <GridColumn Field="PCFNumber" HeaderText="PCF Number (Item)" Width="150"/>

        <GridColumn HeaderText="Delete Now" Width="120" TextAlign="TextAlign.Center" AllowFiltering="false" AllowSorting="false">
            <Template Context="ctx">
                @{
                    var row = (PcfManager.Models.PCFDetail)ctx;   // cast from object -> PCFDetail
                }
                <input type="checkbox"
                       checked="@row.DeleteNow"
                       @onchange="(ChangeEventArgs e) => OnDeleteNowChanged(row, (bool)e.Value!)" />
            </Template>
        </GridColumn>

        <GridColumn HeaderText="Delete Later" Width="130" TextAlign="TextAlign.Center" AllowFiltering="false" AllowSorting="false">
            <Template Context="ctx">
                @{
                    var row = (PcfManager.Models.PCFDetail)ctx;
                }
                <input type="checkbox"
                       checked="@row.DeleteLater"
                       @onchange="(ChangeEventArgs e) => OnDeleteLaterChanged(row, (bool)e.Value!)" />
            </Template>
        </GridColumn>
        <GridColumn Field="FY2023_Qty" HeaderText="FY23 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2024_Qty" HeaderText="FY24 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2025_Qty" HeaderText="FY25 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2026_Qty" HeaderText="FY26 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
    </GridColumns>
</SfGrid>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="ApplyDeletes" disabled="@isBusy">
        @(isBusy ? "Applying..." : "Apply Deletes")
    </button>
    <span class="ms-3">@statusMessage</span>
</div>



@if (isLoading)
{
    <p>Loading data...</p>
}

@code {
    private List<PCFDetail> pcfDetails = new();
    private bool isLoading = true;
    private bool isBusy = false;
    private SfGrid<PCFDetail> MyDetGrid;
    private GridFilterSettings filterSettings = new GridFilterSettings();
    private string statusMessage = string.Empty;
    private string? defaultLayoutJson;
    private string newLayoutName = string.Empty;
    private string selectedLayoutName = string.Empty;
    // name -> persisted JSON
    private Dictionary<string, string> savedLayouts = new();
    // Storage key for all named layouts for this grid
    private const string LayoutsStoreKey = "PcfsGridLayouts"; // change if you rename the grid
    private bool firstRender = true;
    //[Inject] public Blazored.LocalStorage.ILocalStorageService LocalStorage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        

        pcfDetails = await DataService.GetAllPCFDetailsWithQtyAsync();
        isLoading = false;
    }
 
    private string GetPrivateLabelDisplay(object data, string columnName)
    {
        var item = data as PCFDetail;
        return item?.PrivateLabelFlag == 1 ? "Yes" : "No";
    }

    public async Task ToolbarClickHandler(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id == "PcfsDetGrid_excelexport") //Id is combination of Grid's ID and itemname
        {
            var ExcelFileName = $"PCFReport.xlsx";
            ExcelExportProperties exportProperties = new ExcelExportProperties
			{
				FileName = ExcelFileName
			};
            await this.MyDetGrid.ExportToExcelAsync(exportProperties);
        }
    }
    private async Task ClearFilters()
    {
        await MyDetGrid.ClearFilteringAsync();

    }

    // Ensure only one of the two checkboxes is selected per row
    private void OnDeleteNowChanged(PCFDetail row, bool isChecked)
    {
        row.DeleteNow = isChecked;
        if (isChecked) row.DeleteLater = false;
        StateHasChanged();
    }

    private void OnDeleteLaterChanged(PCFDetail row, bool isChecked)
    {
        row.DeleteLater = isChecked;
        if (isChecked) row.DeleteNow = false;
        StateHasChanged();
    }

    private async Task ApplyDeletes()
    {
        isBusy = true;
        statusMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Aggregate selections
            var deleteNow = pcfDetails.Where(x => x.DeleteNow).ToList();
            var deleteLater = pcfDetails.Where(x => x.DeleteLater).ToList();

            // 1) Immediate deletes (remove from PCF)
            if (deleteNow.Count > 0)
            {
                // Use the identifiers you need — example uses PCFNum + ItemNum as a composite key
                var nowKeys = deleteNow.Select(x => new { x.PCFNum, x.ItemNum }).ToList();
                //await DataService.RemoveItemsFromPCFAsync(nowKeys);

                // Optionally reflect removal in the UI (remove rows)
                pcfDetails.RemoveAll(r => r.DeleteNow);
            }

            // 2) Persist "delete later" requests
            if (deleteLater.Count > 0)
            {
               

                var laterPayload = deleteLater.Select(x => new
                {
                    x.PCFNum,
                    x.ItemNum,
                    RequestedOnUtc = DateTime.Now,
                    Reason = "Sales marked for later removal" // optional
                }).ToList();

                await DataService.MarkItemsForDeletionAsync(laterPayload);

                // Clear the flags to show they've been saved
                foreach (var r in pcfDetails.Where(r => r.DeleteLater))
                    r.DeleteLater = false;
            }

            statusMessage = BuildResultMessage(deleteNow.Count, deleteLater.Count);
        }
        catch (Exception ex)
        {
            statusMessage = $"Something went wrong applying deletes: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            await MyDetGrid.Refresh();
            StateHasChanged();
        }
    }

    private static string BuildResultMessage(int nowCount, int laterCount)
        => $"Deleted now: {nowCount}, queued for later: {laterCount}.";

    private async Task SaveLayoutAs()
    {
        if (string.IsNullOrWhiteSpace(newLayoutName)) return;

        var current = await MyDetGrid.GetPersistDataAsync();
        savedLayouts[newLayoutName.Trim()] = current;
       // await LocalStorage.SetItemAsync(LayoutsStoreKey, savedLayouts);
        selectedLayoutName = newLayoutName.Trim();
        newLayoutName = string.Empty;
    }

    private async Task ApplySelectedLayout()
    {
        if (!string.IsNullOrWhiteSpace(selectedLayoutName) &&
            savedLayouts.TryGetValue(selectedLayoutName, out var json))
        {
            await MyDetGrid.SetPersistDataAsync(json);
            await MyDetGrid.Refresh();
        }
    }

    private async Task ResetToDefault()
    {
        // Option A: apply the captured default JSON
        if (!string.IsNullOrEmpty(defaultLayoutJson))
        {
            await MyDetGrid.SetPersistDataAsync(defaultLayoutJson);
            await MyDetGrid.Refresh();
        }

        // Option B (optional): also clear Syncfusion’s own localStorage entry for this grid
        // await JS.InvokeVoidAsync("pcfGrid.clearSyncfusionPersistence", "PcfsGrid");
    }
}

<style>
    .e-grid .e-headercell {
        font-size: 0.4rem;
        padding: 0.0rem 0;
        line-height: 1.5;
    }
    .e-grid .e-rowcell {
        font-size: 0.7rem;
        padding: 0.3rem 0;
        line-height: 1.2;
    }
    .e-grid .e-filtermenudiv {
        margin: 2px 0.15rem 1px 0.01rem;
    }
    .e-grid .e-headercell .e-filtered::before {
        color: red;
        font-weight: bold;
    }
  .e-grid .e-headercell .e-headertext {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 13px;          /* tweak as needed */
        font-weight: 700;          /* 400–700 */
        letter-spacing: .2px;      /* optional */
    }
    .worksheet-header-row {
        display: flex;
        align-items: center;
        width: 100%;
        margin-bottom: 2rem;
    }
    .worksheet-header-title {
        flex: 1;
        text-align: left;
    }
    .worksheet-header-btn {
        flex: 1;
        display: flex;
        justify-content: center;
    }
    .worksheet-header-spacer {
        flex: 1;
    }
    body { }
    :deep(.pcf-grid-scroll) {
        overflow-x: auto;          /* show horizontal scrollbar when needed */
    }

    /* Make the grid wider than narrow screens so scrolling kicks in */
    :deep(#PcfsDetGrid.e-grid) {
        min-width: 1000px;         /* adjust to whatever fits your columns */
    }
 
</style>
