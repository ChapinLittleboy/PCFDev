@page "/pcf-detail-report"
@using System.Diagnostics
@using PcfManager.Models  
@using Syncfusion.Blazor.Grids
@using PcfManager.Services
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.SplitButtons
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Navigations 
@using ChangeEventArgs = Microsoft.AspNetCore.Components.ChangeEventArgs

@inject PcfManager.Services.DataService DataSvc
@inject IJSRuntime JS

<PageTitle>PCF Detail Report</PageTitle>

<h3>PCF Detail Report</h3>
<div>
    <div class="active-filters">
        <button @onclick="ClearFilters">Clear Filters</button>

        <!--
        <span class="divider">|</span>
        <strong class="small-text">Active Filters:</strong>
        <span class="small-text">@activeFilters</span>
        -->
    </div>

</div>
<!-- Column toggles -->
<SfButton style="margin-bottom:5px" OnClick="Show" CssClass="e-outline" Content="Open column chooser"></SfButton>
<!-- Blazor Server: Pages/_Host.cshtml  |  WASM: wwwroot/index.html -->


<div class="col-lg-12 control-section toast-default-section">
    <SfToast ID="toast_default" @ref="ToastObj" Title="PCF Editor"   Content="@ToastMessage" Timeout="8000" Icon="e-warning">
        <ToastPosition X="@ToastPosition"></ToastPosition>
    </SfToast>

</div>


<SfGrid ID="PcfsDetGrid" @ref="MyDetGrid" DataSource="@pcfDetails" AllowSorting="true" AllowPaging="true" AllowFiltering="true"
        AllowExcelExport="true" 
        Toolbar="ToolbarItems"
        AllowReordering="true" AllowResizing="true"
        AllowTextWrap="true"
        EnablePersistence="false"
        ShowColumnChooser="true"
        AllowGrouping="true" Height="auto" Width="90%">
    <GridTextWrapSettings WrapMode="WrapMode.Header" />
    <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel">
        <GridFilterColumns>
            <GridFilterColumn Field="PCFStatusText" MatchCase=false Operator="Syncfusion.Blazor.Operator.Equal"  Value="@PcfStatusValue"></GridFilterColumn>
            
        </GridFilterColumns>
    </GridFilterSettings>
    <GridEvents OnToolbarClick="ToolbarClickHandler" TValue="PCFDetail"></GridEvents>
    <GridPageSettings  PageSize="12" PageSizes="@(new string[] { "12", "50", "100", "All" })"></GridPageSettings>
    <GridColumns>
        <GridColumn Field="PCFNum" HeaderText="PCF #" TextAlign="TextAlign.Center" Width="100" Type="ColumnType.Number" />
        <GridColumn Field="CustomerNumber" HeaderText="Customer #" Width="120" />
        <GridColumn Field="CustomerName" HeaderText="Customer Name" Width="200" />
        <GridColumn Field="CorpCustNum" HeaderText="Corp Cust Number" Width="120" />
        <GridColumn Field="StartDate" HeaderText="Start Date" Format="d" Type="ColumnType.Date" Width="120" />
        <GridColumn Field="EndDate" HeaderText="End Date" Format="d" Type="ColumnType.Date" Width="120" />
        <GridColumn Field="PCFStatusText" HeaderText="PCF Status" Width="170"></GridColumn>
        <GridColumn Field="PcfTypeText" HeaderText="Type" Width="220"></GridColumn>
        <GridColumn Field="ItemNum" HeaderText="Item #" Width="120" />
        <GridColumn Field="ItemDesc" HeaderText="Item Description" Width="200" />
        <GridColumn Field="ItemStatusText" HeaderText="Item Status" Width="160"></GridColumn>
        <GridColumn Field="PrivateLabelFlag" HeaderText="Private Label" Width="120" />
        <GridColumn Field="CustNum" HeaderText="Cust #" Width="100" />
        <GridColumn Field="VPSalesDate" HeaderText="VP Sales Date" Format="d" Type="ColumnType.Date" Width="130" />
        <GridColumn Field="BuyingGroup" HeaderText="Buying Group" Width="150" />
        <GridColumn Field="GeneralNotes" HeaderText="Notes" Width="200" />
        <GridColumn Field="PromoPaymentTermsText" HeaderText="Payment Terms" Width="160" />
        <GridColumn Field="PromoFreightTerms" HeaderText="Freight Terms" Width="160" />
        <GridColumn Field="FreightMinimums" HeaderText="Freight Min." Width="130" />
        <GridColumn Field="SalesManager" HeaderText="Sales Manager" Width="150" />
        <GridColumn Field="BillToAddress" HeaderText="Bill To Address" Width="200" />
        <GridColumn Field="BillToCity" HeaderText="City" Width="120" />
        <GridColumn Field="BTState" HeaderText="State" Width="80" />
        <GridColumn Field="BTZip" HeaderText="ZIP" Width="100" />
        <GridColumn Field="EUT" HeaderText="EUT" Width="100" />
        <GridColumn Field="PCFNumber" HeaderText="PCF Number (Item)" Width="150" />

        <GridColumn HeaderText="Delete Now" Width="120" TextAlign="TextAlign.Center" AllowFiltering="false" AllowSorting="false">
            <Template Context="ctx">
                @{
                    var row = (PcfManager.Models.PCFDetail)ctx;   // cast from object -> PCFDetail
                }
                <input type="checkbox"
                       checked="@row.DeleteNow"
                       @onchange="(ChangeEventArgs e) => OnDeleteNowChanged(row, (bool)e.Value!)" />
            </Template>
        </GridColumn>

        <GridColumn HeaderText="Delete Later" Width="130" TextAlign="TextAlign.Center" AllowFiltering="false" AllowSorting="false">
            <Template Context="ctx">
                @{
                    var row = (PcfManager.Models.PCFDetail)ctx;
                }
                <input type="checkbox"
                       checked="@row.DeleteLater"
                       @onchange="(ChangeEventArgs e) => OnDeleteLaterChanged(row, (bool)e.Value!)" />
            </Template>
        </GridColumn>
        <GridColumn Field="FY2023_Qty" HeaderText="FY23 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2024_Qty" HeaderText="FY24 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2025_Qty" HeaderText="FY25 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2026_Qty" HeaderText="FY26 Qty"
                    Type="ColumnType.Number" Format="N0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2023_Sales" HeaderText="FY23 Sales"
                    Type="ColumnType.Number" Format="C0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2024_Sales" HeaderText="FY24 Sales"
                    Type="ColumnType.Number" Format="C0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2025_Sales" HeaderText="FY25 Sales"
                    Type="ColumnType.Number" Format="C0" TextAlign="TextAlign.Right" Width="130" />
        <GridColumn Field="FY2026_Sales" HeaderText="FY26 Sales"
                    Type="ColumnType.Number" Format="C0" TextAlign="TextAlign.Right" Width="130" />
    </GridColumns>

</SfGrid>


<div class="mt-3">
    <button class="btn btn-primary" @onclick="ApplyDeletes" disabled="@isBusy">
        @(isBusy ? "Applying..." : "Apply Deletes")
    </button>
    <span class="ms-3">@statusMessage</span>
</div>



@if (isLoading)
{
    <p>Loading data...</p>
}

@code {
    private List<PCFDetail> pcfDetails = new();
    private bool isLoading = true;
    private bool isBusy = false;
    private SfGrid<PCFDetail> MyDetGrid;
    private GridFilterSettings filterSettings = new GridFilterSettings();
    private string statusMessage = string.Empty;
    private string? defaultLayoutJson;
    private string newLayoutName = string.Empty;
    private string selectedLayoutName = string.Empty;
    // name -> persisted JSON
    private Dictionary<string, string> savedLayouts = new();
    // Storage key for all named layouts for this grid
    private const string LayoutsStoreKey = "PcfsGridLayouts"; // change if you rename the grid
    private bool firstRender = true;
    //[Inject] public Blazored.LocalStorage.ILocalStorageService LocalStorage { get; set; }
    private Dictionary<(int Pcf, string Item), bool> _originalDeleteLater = new();
    private static (int Pcf, string Item) KeyOf(PCFDetail x)
        => (x.PCFNum, (x.ItemNum ?? string.Empty).Trim());

    private List<string> selectedFields = new();
    public record ColumnItem(string Field, string HeaderText);
    private List<ColumnItem> Columns;
    private static int FiscalYearEndYear(DateTime asOf)
        => asOf.Month >= 9 ? asOf.Year + 1 : asOf.Year;
    private Dictionary<string,bool> selected = new(StringComparer.OrdinalIgnoreCase);
    public List<object> ToolbarItems = default!;


    private SfToast ToastObj;
    private string ToastMessage = "Please change PageSize to ‘All’ before exporting.";
    private string ToastPosition = "Center";
    private string PcfStatusValue = "Approved"; // default filter value
    private bool IsCorpCustFiltered()
        => MyDetGrid?.FilterSettings?.Columns?.Any(c => c.Field == nameof(PCFDetail.CorpCustNum)) == true;
    private string GetCorpCustFilterSummary()
    {
        var cols = MyDetGrid?.FilterSettings?.Columns?
            .Where(c => c.Field == nameof(PCFDetail.CorpCustNum))
            .ToList() ?? new();

        if (cols.Count == 0) return null;

        // Excel filter can create multiple entries for the same column.
        // Entries sharing the same Uid are OR-ed together by the grid.
        var groups = cols.GroupBy(c => c.Uid ?? c.Field)
            .Select(g =>
                string.Join($" {g.First().Predicate?.ToUpper() ?? "OR"} ",
                    g.Select(c => $"{c.Operator} '{c.Value}'")))
            .ToList();

        // If there are multiple Uid groups, the grid ANDs them.
        return string.Join(" AND ", groups);
    }
    private string GetCorpCustFilterSimple()
    {
        var cols = MyDetGrid?.FilterSettings?.Columns?
            .Where(c => c.Field == nameof(PCFDetail.CorpCustNum))
            .ToList() ?? new();

        if (cols.Count == 0) return null;

        // Excel filter can create multiple entries for the same column.
        // Entries sharing the same Uid are OR-ed together by the grid.
        var values = string.Join(" or ", cols.Select(c => c.Value));

        // If there are multiple Uid groups, the grid ANDs them.
        return values;
    }



    // Helpers to compute record range text



    public void Show()
    {
        MyDetGrid.OpenColumnChooserAsync(100, 40);
    }



    protected override async Task OnInitializedAsync()
    {

        var fy = FiscalYearEndYear(DateTime.Now);
        Columns = new()
        {
            new("ItemDesc", "Item Description"),
            new("ItemStatus", "Item Status"),
            new("ProposedPrice", "Accepted Price"),
            new("Margin", "Margin"),
            new("PP1Price", "$4K Price (PP1)"),
            new("Pct to 4k", "Pct to 4k"),
            new("PP2Price", "$12.5k Price (PP2)"),
            new("FOBPrice", "FOB"),
            new("Family_Code", "Family Code"),

            // Dynamic FY labels (current + prior years)
            new("CurrentFYSales", $"FY{fy} Sales"),
            new("CurrentFYUnits", $"FY{fy} Units"),

            new("Prior1FYSales", $"FY{fy - 1} Sales"),
            new("Prior1FYUnits", $"FY{fy - 1} Units"),

            new("Prior2FYSales", $"FY{fy - 2} Sales"),
            new("Prior2FYUnits", $"FY{fy - 2} Units"),
        };

        foreach (var c in Columns)
            selected[c.Field] = true;   // or false, your default

        ToolbarItems = new()
        {
            //"ExcelExport",                         // built-in item
            new ToolbarItem { Template = CustomButton } // your custom template


        };
        pcfDetails = await DataSvc.GetAllPCFDetailsWithQtyAsync();
        _originalDeleteLater = AggregateDeleteLater(pcfDetails);
        isLoading = false;
    }

    public const string PasteIconCss = "e-btn-icons e-paste";
    public const string PasteSpecialIconCss = "e-btn-icons e-paste-special";
    public const string PasteAsFormulaIconCss = "e-btn-icons e-paste-formula";
    public const string PasteAsHyperlinkIconCss = "e-btn-icons e-paste-hyperlink";
   
    private string Current = "gridExport";  
   private SfSplitButton SplitBtn = default!;

    private RenderFragment CustomButton => @<SfSplitButton @ref="SplitBtn" CssClass="e-flat" Content="Export Excel">
                                               <SplitButtonEvents Clicked="OnPrimaryClicked"
                                                                  ItemSelected="OnItemSelected" />
                                               <DropDownMenuItems>
                                                   <DropDownMenuItem Id="gridExport" Text="Export Grid as Shown" IconCss="@PasteIconCss"></DropDownMenuItem>
                                                   <DropDownMenuItem Id="reviewExport" Text="Export in Review Format" IconCss="@PasteSpecialIconCss"></DropDownMenuItem>

                                               </DropDownMenuItems>
                                               
                                           </SfSplitButton>


    ;

    private async Task OnGridCreated()
    {
        // Grid is definitely non-null here
        foreach (var c in Columns)
        {
            var col = await MyDetGrid.GetColumnByField(c.Field); // or GetColumnByFieldAsync in your version
            selected[c.Field] = col?.Visible ?? true;
        }

        StateHasChanged();
    }
    private Task OnPrimaryClicked(Syncfusion.Blazor.SplitButtons.ClickEventArgs _)
    {
        if (Current == "gridExport")
            return gridExport();
        else
        {
            return ExportReviewFormat();
        }
    }
    private string PrimaryLabel => Current switch
    {
        "gridExport" => "Export Grid as Shown",
        "reviewExport" => "Export in Review Format)",
        _      => "Export"
    };
    private async Task OnItemSelected(Syncfusion.Blazor.SplitButtons.MenuEventArgs args)
    {
        Current = args.Item.Id;        // make the chosen item the new default
        // Optionally kick it off right away:
        if (args.Item.Id == "gridExport") 
        {
            await gridExport();
        }
        else if (args.Item.Id == "reviewExport") await ExportReviewFormat();

        // Update the main button label
        // (Content is a settable property; using @ref lets us update it)
        SplitBtn.Content = PrimaryLabel;

        StateHasChanged();
    }

    private async Task gridExport()
    {
        var ExcelFileName = $"PCFReport.xlsx";
        ExcelExportProperties exportProperties = new ExcelExportProperties
        {
            FileName = ExcelFileName
        };
        await this.MyDetGrid.ExportToExcelAsync(exportProperties);
    }


    private async Task ExportReviewFormat()
    {
        string ExcelFileName = $"PCFReviews.xlsx";
        if (IsCorpCustFiltered())
        {
            var filterCorp = GetCorpCustFilterSimple();
            ExcelFileName = $"PCFReviews CorpCust {filterCorp}.xlsx";
        }
        else
        {
            ExcelFileName = $"PCFReviews.xlsx";
        }

        ExcelExportProperties exportProperties = new ExcelExportProperties
        {
            FileName = ExcelFileName
        };


        var viewObjects = await MyDetGrid.GetCurrentViewRecordsAsync();
        // MyDetGrid.PageSettings.PageSize = originalPageSize;

        var filtered = viewObjects
            .OfType<PCFDetail>()
            .ToList();

        var ps = MyDetGrid.PageSettings.PageSize;
        if (ps < MyDetGrid.TotalItemCount)
        {
            ToastObj.Content = "You must set Number of Items per page to a higher number";
            ToastObj.CssClass = "e-toast-warning";
            await this.ToastObj.ShowAsync();
            return;
        }

        // await MyDetGrid.UngroupColumnAsync("PCFNum"); ;
        // await MyDetGrid.UngroupColumnAsync("CorpCustNum"); ;
        // await MyDetGrid.UngroupColumnAsync("CustomerNumber"); ;
        // await MyDetGrid.UngroupColumnAsync("CustomerName"); ;
        // var filteredRecords = await MyDetGrid.GetFilteredRecordsAsync();

        if (filtered.Count == 0)
        {
            // nothing to export
            await JS.InvokeVoidAsync("alert", "No filtered rows to export.");
            return;
        }

        // 2) Decide which columns belong in header vs detail
        //    (Tune these to your exact taste/business rules)
        var headerFields = new (string Label, Func<PCFDetail, object?> Value)[]
        {
            ("PCF #",              x => x.PCFNum),
            ("Customer #",         x => x.CustomerNumber),
            ("Customer Name",      x => x.CustomerName),
            ("Corp Cust Number",   x => x.CorpCustNum),
            ("Start Date",         x => x.StartDate),
            ("End Date",           x => x.EndDate),
            ("PCF Status",         x => x.PCFStatusText),
            ("Type",               x => x.PcfTypeText),
            ("Buying Group",       x => x.BuyingGroup),
            ("Sales Manager",      x => x.SalesManager),
            // ("VP Sales Date",      x => x.VPSalesDate),
            ("Bill To Address",    x => x.BillToAddress),
            ("City",               x => x.BillToCity),
            ("State",              x => x.BTState),
            ("ZIP",                x => x.BTZip),
            // ("Payment Terms",      x => x.PromoPaymentTermsText),
            // ("Freight Terms",      x => x.PromoFreightTerms),
            // ("Freight Min.",       x => x.FreightMinimums),
            ("Notes",              x => x.GeneralNotes),
        };

        var detailColumns = new (string Header, Func<PCFDetail, object?> Value, bool RightAlign, string? Format)[]
        {
            ("Item #",            x => x.ItemNum,              false, null),
            ("Item Description",  x => x.ItemDesc,             false, null),
            ("Item Status",       x => x.ItemStatusText,           false, null),
            ("Private Label",     x => x.PrivateLabelFlag,     false, null),
            //("Cust #",            x => x.CustNum,              false, null),
           // ("EUT",               x => x.EUT,                  false, null),
           // ("PCF Number (Item)", x => x.PCFNumber,            false, null),

           ("FY23 Qty",          x => x.FY2023_Qty,           true,  "0"),
           ("FY24 Qty",          x => x.FY2024_Qty,           true,  "0"),
           ("FY25 Qty",          x => x.FY2025_Qty,           true,  "0"),
           ("FY26 Qty",          x => x.FY2026_Qty,           true,  "0"),
           ("FY23 Sales",          x => x.FY2023_Sales,           true,  "$#,##0"),
           ("FY24 Sales",          x => x.FY2024_Sales,           true,  "$#,##0"),
           ("FY25 Sales",          x => x.FY2025_Sales,           true,  "$#,##0"),
           ("FY26 Sales",          x => x.FY2026_Sales,           true,  "$#,##0")
        };

        // 3) Build the Excel
        byte[] bytes;

        using (var excelEngine = new Syncfusion.XlsIO.ExcelEngine())
        {
            var application = excelEngine.Excel;
            application.DefaultVersion = Syncfusion.XlsIO.ExcelVersion.Xlsx;

            var workbook = application.Workbooks.Create(1);
            var ws = workbook.Worksheets[0];
            ws.Name = "PCF Export";

            int row = 1;
            if (IsCorpCustFiltered())
            {
                var ccfilter = GetCorpCustFilterSimple();
                ws.Range["A" + row].Text = $"PCF Review for Corp Customer(s) {ccfilter}";
            }
            else
            {
                ws.Range["A" + row].Text = "PCF Review";
            }
            // Optional: a big title on top
           // ws.Range["A" + row].Text = "PCF Export (Filtered)";
            ws.Range["A" + row].CellStyle.Font.Bold = true;
            ws.Range["A" + row].CellStyle.Font.Size = 16;
            row += 2;

            // group by CustNum then PCFNum
            var groups = filtered
                .GroupBy(x => x.CustNum)
                .OrderBy(g => g.Key)
                .SelectMany(g =>
                    g.GroupBy(x => x.PCFNum)
                     .OrderBy(gg => gg.Key));

            foreach (var pcfGroup in groups)
            {
                var first = pcfGroup.First();

                // --- Header block title ---
                ws.Range["A" + row].Text = $"Customer {first.CustNum} - PCF {first.PCFNum}";
                ws.Range["A" + row].CellStyle.Font.Bold = true;
                ws.Range["A" + row].CellStyle.Font.Size = 12;
                row++;

                // --- Header key-value pairs (two columns per row: Label in A, Value in B) ---
                foreach (var (Label, Value) in headerFields)
                {
                    ws.Range["A" + row].Text = Label;
                    ws.Range["A" + row].CellStyle.Font.Bold = true;
                    ws.Range["B" + row].Text = FormatCell(Value(first));
                    row++;
                }

                row++; // spacer line

                // --- Detail table header ---
                int col = 1;
                foreach (var (Header, _, _, _) in detailColumns)
                {
                    ws.Range[row, col].Text = Header;
                    ws.Range[row, col].CellStyle.Font.Bold = true;
                    ws.Range[row, col].CellStyle.Borders[Syncfusion.XlsIO.ExcelBordersIndex.EdgeBottom].LineStyle =
                        Syncfusion.XlsIO.ExcelLineStyle.Thin;
                    col++;
                }
                row++;

                // --- Detail table rows (each item record for this PCF) ---
                foreach (var item in pcfGroup)
                {
                    col = 1;
                    foreach (var (_, Value, RightAlign, Format) in detailColumns)
                    {
                        var cell = ws.Range[row, col];

                        var v = Value(item);
                        
                        if (v is DateTime dt)
                        {
                            cell.DateTime = dt;
                            cell.NumberFormat = "m/d/yyyy";
                        }
                        else if (v is int or long or double or decimal)
                        {
                            cell.Number = Convert.ToDouble(v);
                            if (!string.IsNullOrEmpty(Format))
                            {
                                cell.NumberFormat = Format;
                            }
                         




                            if (RightAlign)
                                cell.CellStyle.HorizontalAlignment = Syncfusion.XlsIO.ExcelHAlign.HAlignRight;
                        }
                        else if (v is bool b)
                        {
                            cell.Text = b ? "Yes" : "No";
                        }
                        else
                        {
                            cell.Text = v?.ToString() ?? string.Empty;
                        }

                        col++;
                    }
                    row++;
                }

                // Fit columns for the section
                ws.UsedRange.AutofitColumns();
                ws.Range["B:B"].ColumnWidth = 50;

                // --- Separate PCFs with blank rows ---
                row += 3;
            }

            using var ms = new MemoryStream();
            workbook.SaveAs(ms);
            bytes = ms.ToArray();
        }

        // 4) Download to the browser
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync(
            "downloadFile",
            $"{ExcelFileName}",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            bytes
        );

        ToastObj.Timeout = 2000;
        ToastObj.Content = "Your file is complete";
        ToastObj.CssClass = "e-toast-success";
        await this.ToastObj.ShowAsync();





        //await this.MyDetGrid.ExportToExcelAsync(exportProperties);
    }

    private static string FormatCell(object? value)
    {
        if (value is null) return string.Empty;
        if (value is DateTime dt) return dt.ToString("d");
        return value.ToString() ?? string.Empty;
    }



    public void change(string name, Syncfusion.Blazor.Buttons.ChangeEventArgs<bool> args)
    {
        if (this.MyDetGrid != null)
        {
            if (args.Checked)
            {
                this.MyDetGrid.ShowColumnAsync(name, "Field");
            }
            else
            {
                this.MyDetGrid.HideColumnAsync(name, "Field");
            }
        }
        StateHasChanged();
    }



    // Instant apply per button
    private async Task ToggleColumnAsync(string field, bool isSelected)
    {
        if (field == "Pct to 4k")
        {
            selected[field] = isSelected;
            if (isSelected)
                await MyDetGrid.ShowColumns(field, "HeaderText");
            else
                await MyDetGrid.HideColumns(field, "HeaderText");
        }
        else
        {
            selected[field] = isSelected;
            if (isSelected)
                await MyDetGrid.ShowColumns(field, "Field");
            else
                await MyDetGrid.HideColumns(field, "Field");
        }

        StateHasChanged();
    }

    private static Dictionary<(int Pcf, string Item), bool>
        AggregateDeleteLater(IEnumerable<PCFDetail> rows)
    {
        var dict = new Dictionary<(int Pcf, string Item), bool>();
        foreach (var r in rows)
        {
            var key = KeyOf(r);
            if (dict.TryGetValue(key, out var prev))
                dict[key] = prev || r.DeleteLater;   // OR combine
            else
                dict[key] = r.DeleteLater;
        }
        return dict;
    }

    private string GetPrivateLabelDisplay(object data, string columnName)
    {
        var item = data as PCFDetail;
        return item?.PrivateLabelFlag == 1 ? "Yes" : "No";
    }

    public async Task ToolbarClickHandler(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id == "PcfsDetGrid_excelexport") //Id is combination of Grid's ID and itemname
        {
            var ExcelFileName = $"PCFReport.xlsx";
            ExcelExportProperties exportProperties = new ExcelExportProperties
            {
                FileName = ExcelFileName
            };
            await this.MyDetGrid.ExportToExcelAsync(exportProperties);
        }
    }
    private async Task ClearFilters()
    {
        await MyDetGrid.ClearFilteringAsync();

    }

    // Ensure only one of the two checkboxes is selected per row
    private void OnDeleteNowChanged(PCFDetail row, bool isChecked)
    {
        row.DeleteNow = isChecked;
        if (isChecked) row.DeleteLater = false;
        StateHasChanged();
    }

    private void OnDeleteLaterChanged(PCFDetail row, bool isChecked)
    {
        row.DeleteLater = isChecked;
        if (isChecked) row.DeleteNow = false;
        StateHasChanged();
    }

    private async Task ApplyDeletes()
    {
        isBusy = true;
        statusMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Aggregate selections
            // var deleteNow = pcfDetails.Where(x => x.DeleteNow).ToList();
            // var deleteLater = pcfDetails.Where(x => x.DeleteLater).ToList();
            var deleteNowRows = pcfDetails.Where(x => x.DeleteNow).ToList();
            var currentLater = AggregateDeleteLater(pcfDetails);
            bool WasLater((int Pcf, string Item) k)
                => _originalDeleteLater.TryGetValue(k, out var was) && was;
            bool IsLater((int Pcf, string Item) k)
                => currentLater.TryGetValue(k, out var now) && now;
            var newlyMarkedLater = currentLater
                .Where(kv => kv.Value && !WasLater(kv.Key))         // false -> true (or not present -> true)
                .Select(kv => new { PCFNum = kv.Key.Pcf, ItemNum = kv.Key.Item, Reason = "Slow Sales" })
                .ToList();
            var newlyUnmarkedLater = _originalDeleteLater
                .Where(kv => kv.Value && !IsLater(kv.Key))          // true -> false (or missing now)
                .Select(kv => new { PCFNum = kv.Key.Pcf, ItemNum = kv.Key.Item })
                .ToList();

            // 1) Immediate deletes (remove from PCF)
            if (deleteNowRows.Count > 0)
            {
                // Use the identifiers you need — example uses PCFNum + ItemNum as a composite key
                var nowKeys = deleteNowRows.Select(x => new { x.PCFNum, x.ItemNum }).ToList();
                await DataSvc.RemoveItemsFromPCFAsync(nowKeys);

                // Optionally reflect removal in the UI (remove rows)
                pcfDetails.RemoveAll(r => r.DeleteNow);

                foreach (var r in deleteNowRows)
                    _originalDeleteLater.Remove((r.PCFNum, r.ItemNum));
            }

            // 2) Apply: Mark later (only newly marked)
            if (newlyMarkedLater.Count > 0)
            {

                /*
                var laterPayload = deleteLater.Select(x => new
                {
                    x.PCFNum,
                    x.ItemNum,
                    RequestedOnUtc = DateTime.Now,
                    Reason = "Sales marked for later removal" // optional
                }).ToList();
                */

                await DataSvc.MarkItemsForDeletionAsync(newlyMarkedLater);



                // Update snapshot to reflect new true state
                foreach (var nm in newlyMarkedLater)
                    _originalDeleteLater[(nm.PCFNum, nm.ItemNum)] = true;
            }

            //statusMessage = BuildResultMessage(deleteNow.Count, deleteLater.Count);

            // E) Apply: Unmark later (only newly unmarked)
            if (newlyUnmarkedLater.Count > 0)
            {
                await DataSvc.UnmarkItemsForDeletionAsync(newlyUnmarkedLater);
                // Update snapshot to reflect new false state
                foreach (var um in newlyUnmarkedLater)
                    _originalDeleteLater[(um.PCFNum, um.ItemNum)] = false;
            }

            statusMessage = $"Deleted now: {deleteNowRows.Count}, newly marked later: {newlyMarkedLater.Count}, unmarked later: {newlyUnmarkedLater.Count}.";



        }
        catch (Exception ex)
        {
            statusMessage = $"Something went wrong applying deletes: {ex.Message}";
        }
        finally
        {
            isBusy = false;
            await MyDetGrid.Refresh();
            StateHasChanged();
        }
    }

    private static string BuildResultMessage(int nowCount, int laterCount)
        => $"Deleted now: {nowCount}, queued for later: {laterCount}.";

    private async Task SaveLayoutAs()
    {
        if (string.IsNullOrWhiteSpace(newLayoutName)) return;

        var current = await MyDetGrid.GetPersistDataAsync();
        savedLayouts[newLayoutName.Trim()] = current;
        // await LocalStorage.SetItemAsync(LayoutsStoreKey, savedLayouts);
        selectedLayoutName = newLayoutName.Trim();
        newLayoutName = string.Empty;
    }

    private async Task ApplySelectedLayout()
    {
        if (!string.IsNullOrWhiteSpace(selectedLayoutName) &&
            savedLayouts.TryGetValue(selectedLayoutName, out var json))
        {
            await MyDetGrid.SetPersistDataAsync(json);
            await MyDetGrid.Refresh();
        }
    }

    private async Task ResetToDefault()
    {
        // Option A: apply the captured default JSON
        if (!string.IsNullOrEmpty(defaultLayoutJson))
        {
            await MyDetGrid.SetPersistDataAsync(defaultLayoutJson);
            await MyDetGrid.Refresh();
        }

        // Option B (optional): also clear Syncfusion’s own localStorage entry for this grid
        // await JS.InvokeVoidAsync("pcfGrid.clearSyncfusionPersistence", "PcfsGrid");
    }

    private async Task PrintVisibleColumns()
    {
        if (MyDetGrid != null)
        {
            var visibleColumns = await MyDetGrid.GetColumnsAsync();
            var visibleColumnNames = visibleColumns.Where(c => c.Visible).Select(c => c.Field).ToList();
            Console.WriteLine("Visible Columns: " + string.Join(", ", visibleColumnNames));
        }
    }

    private static readonly Dictionary<int, string> PcfStatusMap = new()
    {
        {  0, "New" },
        {  1, "Awaiting SM Approval" },
        {  2, "Awaiting VP Approval" },
        {  3, "Approved" },
        { -1, "Reopened" },
        { 99, "Expired" }
    };

    private static readonly Dictionary<string, string> ItemStatusMap = new()
    {
        { "A", "Approved" },
        { "O", "Obsolete" },
        { "S", "Slow Moving" }
    };

    private static readonly Dictionary<string, string> PcfTypeMap = new()
    {
        { "W",   "Warehouse (Standard)" },
        { "DS",  "Dropship (Standard)" },
        { "PW",  "Promo Warehouse" },
        { "PD",  "Promo Dropship" },
        { "T",   "Truckload" },
        { "PL",  "Private Label Only" },
        { "D",   "Direct" },
        { "PART","Parts Only" }
    };

    private static string MapPcfStatus(int v) =>
        PcfStatusMap.TryGetValue(v, out var s) ? s : v.ToString();

    private static string MapItemStatus(string v) =>
        (v != null && ItemStatusMap.TryGetValue(v, out var s)) ? s : v ?? string.Empty;

    private static string MapPcfType(string v) =>
        (v != null && PcfTypeMap.TryGetValue(v, out var s)) ? s : v ?? string.Empty;



}

<style>
    .e-grid .e-headercell {
        font-size: 0.4rem;
        padding: 0.0rem 0;
        line-height: 1.5;
    }

    .e-grid .e-rowcell {
        font-size: 0.7rem;
        padding: 0.3rem 0;
        line-height: 1.2;
    }

    .e-grid .e-filtermenudiv {
        margin: 2px 0.15rem 1px 0.01rem;
        

    }

    .e-grid .e-headercell .e-filtered::before {
        color: red;
        font-weight: bold;
    }

    .e-grid .e-headercell .e-headertext {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 13px; /* tweak as needed */
        font-weight: 700; /* 400–700 */
        letter-spacing: .2px; /* optional */
        
    }

    .worksheet-header-row {
        display: flex;
        align-items: center;
        width: 100%;
        margin-bottom: 2rem;
    }

    .worksheet-header-title {
        flex: 1;
        text-align: left;
    }

    .worksheet-header-btn {
        flex: 1;
        display: flex;
        justify-content: center;
    }

    .worksheet-header-spacer {
        flex: 1;
    }

    body {
    }

    :deep(.pcf-grid-scroll) {
        overflow-x: auto; /* show horizontal scrollbar when needed */
    }

    /* Make the grid wider than narrow screens so scrolling kicks in */
    :deep(#PcfsDetGrid.e-grid) {
        min-width: 1000px; /* adjust to whatever fits your columns */
    }
    .e-btngrp-watch::before {
        content: '\e71b';
    }
    .e-btngrp-star::before {
        content: '\e710';
    }
    .e-btngrp-download::before {
        content: '\e712';
    }
    .e-btngrp-bold::before {
        content: '\e71a'
    }
    .e-btngrp-italic::before {
        content: '\e708';
    }
    .e-btngrp-underline::before {
        content: '\e703';
    }
    .button-group-section {
        width: 320px;
        margin: 0 auto;
        margin-top: 1.7%;
        margin-bottom: 1.7%;
    }
    .e-bigger .button-group-section {
        width: 350px;
    }
    .button-group-section .row {
        margin: 0 0 30px 0;
    }
    .button-group-section .row:last-child {
        margin-bottom: 0;
    }
    .button-group-section .row .p:first-child {
        margin-top: 0;
    }
    /* Make the whole button group wrap onto multiple lines */
    .col-toggles.e-btn-group {
        display: flex;           /* ensure flex, not inline-flex */
        flex-wrap: wrap !important;   /* Syncfusion sets nowrap; override it */
        gap: .4rem .6rem;        /* space between buttons (row x column) */
        width: 80%;             /* let it use the row width */
        justify-content: flex-start;
    }

    /* Keep each button sized to its content (no squish) */
    .col-toggles .e-btn {
        flex: 0 0 auto;
    }
    .col-toggles .e-btn.col-toggle { border-radius: 9999px; padding: .35rem .65rem; }

    .col-toggles .e-btn.e-success.e-active { background-color: #198754; color: #fff; }
    .col-toggles .e-btn.e-danger.e-active  { background-color: #dc3545; color: #fff; }

    /* Optional softer look when not active (selected state already flips the class) */
    .col-toggles .e-btn.e-success:not(.e-active) { background: #eaf6ed; color:#0f5132; }
    .col-toggles .e-btn.e-danger:not(.e-active)  { background: #fcebea; color:#842029; }
    .quick-actions { margin-top: .5rem; display: flex; gap: .5rem; }
    .e-btn-sb-icons {
        font-family: 'button-icons';
        line-height: 1;
        font-style: normal;
        font-weight: normal;
        font-variant: normal;
        text-transform: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    .e-play-icon::before {
        content: '\e701';
    }
    .e-pause-icon::before {
        content: '\e705';
    }
    .e-open-icon::before {
        content: '\e70d';
    }
    .e-add-icon::before {
        content: '\e70a';
    }

    .e-btn.e-outline {
        color: var(--bs-primary, #0d6efd); /* works with Bootstrap 5; falls back to a solid blue */
        font-weight: 500
    }    


</style>
