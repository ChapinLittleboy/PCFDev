
@page "/datagrid2/{pcfNumber:int}"

@using BlazorServerDatagridApp2.Data
@using BlazorServerDatagridApp2.Models
@using Dapper
@using Microsoft.Data.SqlClient
@using Syncfusion.Blazor.Grids
@inject IConfiguration Configuration

@if (connectionName == "Development")
{
    <h6 style="color: red; font-weight: bold;">Environment: @connectionName</h6>
}

@code {
    private PCFHeaderDTO pcfHeader;
    [Parameter]
    public int pcfNumber { get; set; } // Route parameter binding

    public string connectionName = "Development";

    protected override async Task OnInitializedAsync()
    {
        //int pcfNumber =  /* Set your PCF number here or get it from route parameter */;

        using (var dbConnection = new SqlConnection(Configuration.GetConnectionString(connectionName)))
        {
            await dbConnection.OpenAsync();
            pcfHeader = await GetHeaderWithItemsAsync(pcfNumber, dbConnection);
        }
    }

    private async Task<PCFHeaderDTO> GetHeaderWithItemsAsync(int pcfNumber, SqlConnection dbConnection)
    {
        // Fetching the header and items using Dapper as previously discussed
        var headerQuery = "SELECT * FROM PCFHeader WHERE PcfNumber = @pcfNumber";
        var header = await dbConnection.QuerySingleOrDefaultAsync<PCFHeaderDTO>(headerQuery, new { PcfNumber = pcfNumber });

        if (header == null) return null; // Handle no result found

        var itemsQuery = "SELECT * FROM PCFItem WHERE HeaderId = @HeaderId";
        var items = await dbConnection.QueryAsync<PCFItemDTO>(itemsQuery, new { HeaderId = header.PcfNumber });
        header.PCFLines = items.ToList();

        return header;
    }
}

<!-- Header Grid for displaying PCFHeaderDTO -->
<SfGrid ID="HeaderGrid" DataSource="@(new List<PCFHeaderDTO> { pcfHeader })">
    <GridColumns>
        <GridColumn Field="CustomerNumber" HeaderText="Customer Number" Width="25"></GridColumn>
        <GridColumn Field="CustomerName" HeaderText="Customer Name" Width="100"></GridColumn>
        <GridColumn Field="PcfNumber" HeaderText="PCF Number" Width="25"></GridColumn>
        <GridColumn Field="StartDate" HeaderText="Start Date" Width="25" Format="d"></GridColumn>
        <GridColumn Field="EndDate" HeaderText="End Date" Width="25" Format="d"></GridColumn>
        <GridColumn HeaderText="Status" Width="25">
            <Template>
                <img src="@pcfHeader.ApprovalStatus.ToIconPath()" alt="status-icon" />
            </Template>
        </GridColumn>
    </GridColumns>
</SfGrid>

<!-- Detail Grid for displaying PCFItemDTO entries within Itemlines -->
@if (pcfHeader != null && pcfHeader.PCFLines != null)
{
    <SfGrid ID="DetailGrid" DataSource="@pcfHeader.PCFLines">
        <GridColumns>
            <GridColumn Field="ItemNumber" HeaderText="Item Number" Width="25"></GridColumn>
            <GridColumn Field="Description" HeaderText="Description" Width="100"></GridColumn>
            <GridColumn Field="Price" HeaderText="Price" Width="25" Format="C"></GridColumn>
            <GridColumn Field="EstimatedSales" HeaderText="Estimated Sales" Width="25" Format="N0"></GridColumn>
            <GridColumn Field="LastYearSales" HeaderText="Last Year's Sales" Width="25" Format="N0"></GridColumn>
        </GridColumns>
    </SfGrid>
}
